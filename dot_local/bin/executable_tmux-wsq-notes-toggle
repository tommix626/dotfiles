#!/usr/bin/env bash
set -u

# Must be inside tmux
tmux display-message -p "#{session_name}" >/dev/null 2>&1 || exit 1

WSQ_BIN="$HOME/.local/bin/wsq"

# Session-dependent notes file (unique per tmux session)
session_name="$(tmux display-message -p "#{session_name}")"
session_id="$(tmux display-message -p "#{session_id}")"   # like $1, $2, etc.

# sanitize name to safe filename; put '-' at end so tr doesn't treat it as a range
safe_name="$(printf '%s' "$session_name" | tr -cs 'A-Za-z0-9._+-' '_' )"
# fallback in case it's empty for any reason
if [[ -z "$safe_name" ]]; then
  safe_name="session"
fi

NOTES_DIR="$HOME/tmux-notes"
NOTES_FILE="$NOTES_DIR/${safe_name}_${session_id}.md"

# Window-scoped state (pane ids)
wsq_pane="$(tmux show-option -wqv "@tux_wsq_pane" 2>/dev/null || true)"
notes_pane="$(tmux show-option -wqv "@tux_notes_pane" 2>/dev/null || true)"

# ---- TOGGLE OFF: autosave notes, then close panes ----
if [[ -n "${wsq_pane}" || -n "${notes_pane}" ]]; then
  if [[ -n "${notes_pane}" ]]; then
    tmux send-keys -t "$notes_pane" Escape ":silent! update" Enter 2>/dev/null || true
    sleep 0.12
  fi

  [[ -n "${wsq_pane}"   ]] && tmux kill-pane -t "$wsq_pane"   2>/dev/null || true
  [[ -n "${notes_pane}" ]] && tmux kill-pane -t "$notes_pane" 2>/dev/null || true

  tmux set-option -wu "@tux_wsq_pane" 2>/dev/null || true
  tmux set-option -wu "@tux_notes_pane" 2>/dev/null || true
  exit 0
fi

# ---- TOGGLE ON: create panes ----
mkdir -p "$NOTES_DIR"
touch "$NOTES_FILE"

cur="$(tmux display-message -p "#{pane_id}")" || exit 1
[[ -x "$WSQ_BIN" ]] || exit 1

# Your tmux: use -l <percent>% (NOT -p)
right="$(tmux split-window -h -l 40% -t "$cur" -P -F "#{pane_id}")" || exit 1
bottom="$(tmux split-window -v -l 50% -t "$right" -P -F "#{pane_id}")" || exit 1

tmux set-option -w "@tux_wsq_pane" "$right"
tmux set-option -w "@tux_notes_pane" "$bottom"

tmux select-pane -t "$right"  -T "WSQ" 2>/dev/null || true
tmux select-pane -t "$bottom" -T "Notes:${safe_name}" 2>/dev/null || true

tmux respawn-pane -k -t "$right" "$WSQ_BIN"
tmux respawn-pane -k -t "$bottom" "vim -n \"$NOTES_FILE\""

# Focus notes pane on open
tmux select-pane -t "$bottom" 2>/dev/null || true
